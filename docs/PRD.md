# 仿Cursor IDE产品需求文档（PRD）

## 1. 产品概述

### 1.1 产品定位
一个基于Web的智能代码编辑器Demo，模仿Cursor IDE的核心功能，通过AI增强开发体验，支持代码库索引、智能代码补全和上下文感知的代码建议。

### 1.2 目标用户
- 前端开发者
- 希望体验AI辅助编程的开发者
- 学习和研究AI编程工具的技术人员

### 1.3 核心价值
- 提供类似Cursor的AI编程体验
- 支持代码库级别的上下文理解
- 实时智能代码建议和补全
- 可视化展示AI检索和推理过程

## 2. 功能需求

### 2.1 基础功能

#### 2.1.1 文件树管理
- 创建、删除、重命名文件和文件夹
- 支持文件类型：.js, .ts, .tsx, .jsx, .md
- 文件树的展开/折叠
- 文件图标显示
- 拖拽移动文件

#### 2.1.2 代码编辑器
- 基于Monaco Editor（VS Code的编辑器核心）
- 语法高亮
- 代码折叠
- 多标签页支持
- 自动保存
- 撤销/重做

#### 2.1.3 类型支持
- TypeScript类型检查
- 自动类型推导
- 类型错误提示
- 智能代码提示（IntelliSense）

### 2.2 AI能力

#### 2.2.1 代码库索引（Codebase Indexing）
**功能描述：**
- 自动扫描项目中的所有代码文件
- 使用AST（抽象语法树）解析代码结构
- 提取类、函数、变量等符号信息
- 生成代码块的向量嵌入（embeddings）
- 建立多层缓存的上下文系统

**技术实现：**
- 使用tree-sitter进行语法解析
- 代码分块策略：
  - 函数级别分块
  - 类级别分块
  - 模块级别分块
- 向量存储方案：
  - 内存向量数据库（开发阶段）
  - 支持持久化存储

#### 2.2.2 智能代码检索
**功能描述：**
- 基于用户当前编辑位置生成查询
- 语义搜索相关代码片段
- 支持多种检索策略：
  - 符号引用检索
  - 语义相似度检索
  - 依赖关系检索

**检索触发机制：**
- 光标位置变化
- 输入特定字符（如"."、"("）
- 手动触发（快捷键）

#### 2.2.3 上下文管理系统
**多层缓存架构：**
1. **即时上下文（Immediate Context）**
   - 当前文件内容
   - 光标位置前后代码
   - 当前函数/类定义

2. **局部上下文（Local Context）**
   - 相关文件（imports/exports）
   - 同目录文件
   - 最近编辑的文件

3. **全局上下文（Global Context）**
   - 项目结构信息
   - 类型定义
   - 配置文件

**语义化处理：**
- 代码注释提取
- 函数签名分析
- 变量作用域分析
- 依赖关系图构建

### 2.3 辅助功能

#### 2.3.1 悬浮面板
- 位置：编辑器右侧
- 功能：
  - 显示当前检索到的相关代码
  - 展示生成的prompt内容
  - 显示AI推理过程
  - 提供相关文档链接

#### 2.3.2 操作追踪
- 记录用户编辑操作
- 分析编码模式
- 优化检索策略

## 3. 技术架构

### 3.1 技术栈
- **前端框架：** Next.js 14 (App Router)
- **UI组件：** Radix UI + Tailwind CSS
- **代码编辑器：** Monaco Editor
- **AI SDK：** Vercel AI SDK
- **状态管理：** Zustand
- **代码解析：** @lezer/javascript, @lezer/typescript
- **向量数据库：** 内存实现（可扩展）

### 3.2 系统架构

```
┌─────────────────────────────────────────────────────────┐
│                      前端应用层                          │
├─────────────────────────────────────────────────────────┤
│  文件树组件 │ Monaco编辑器 │ AI面板 │ 类型提示组件      │
├─────────────────────────────────────────────────────────┤
│                    状态管理层（Zustand）                 │
├─────────────────────────────────────────────────────────┤
│                      服务层                              │
│  ┌─────────┐  ┌──────────┐  ┌─────────┐  ┌──────────┐ │
│  │文件系统  │  │代码解析   │  │AI服务   │  │类型服务   │ │
│  │服务      │  │服务       │  │         │  │          │ │
│  └─────────┘  └──────────┘  └─────────┘  └──────────┘ │
├─────────────────────────────────────────────────────────┤
│                    索引层                                │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │
│  │AST解析器    │  │向量生成器   │  │索引存储     │    │
│  └─────────────┘  └─────────────┘  └─────────────┘    │
├─────────────────────────────────────────────────────────┤
│                  AI集成层（Vercel AI SDK）               │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐             │
│  │Embedding  │  │Chat      │  │Tools     │             │
│  │API        │  │API       │  │API       │             │
│  └──────────┘  └──────────┘  └──────────┘             │
└─────────────────────────────────────────────────────────┘
```

### 3.3 数据流设计

1. **索引流程：**
   ```
   代码文件 → AST解析 → 代码分块 → 向量化 → 存储索引
   ```

2. **检索流程：**
   ```
   用户操作 → 上下文提取 → 查询生成 → 向量检索 → 结果排序 → 展示
   ```

3. **AI交互流程：**
   ```
   检索结果 + 用户意图 → Prompt构建 → LLM调用 → 响应处理 → UI更新
   ```

## 4. 核心算法设计

### 4.1 代码分块算法
```typescript
interface CodeChunk {
  id: string;
  content: string;
  type: 'function' | 'class' | 'module';
  metadata: {
    fileName: string;
    startLine: number;
    endLine: number;
    symbols: string[];
    imports: string[];
    exports: string[];
  };
  embedding?: number[];
}
```

### 4.2 相关性评分算法
- 余弦相似度计算
- 位置权重（距离光标越近权重越高）
- 引用频率权重
- 时间衰减因子

### 4.3 上下文窗口管理
- 动态调整上下文大小
- 优先级队列管理
- Token限制处理

## 5. 用户界面设计

### 5.1 布局设计
```
┌─────────────────────────────────────────────────┐
│                  顶部导航栏                      │
├────────────┬────────────────────────┬───────────┤
│            │                        │           │
│   文件树    │      代码编辑区        │  AI面板   │
│            │                        │           │
│            │                        │           │
│            │                        │           │
└────────────┴────────────────────────┴───────────┘
```

### 5.2 交互设计
- 文件树支持右键菜单
- 编辑器支持快捷键
- AI面板可折叠/展开
- 支持暗色/亮色主题

## 6. 性能优化

### 6.1 索引优化
- 增量索引更新
- 后台异步处理
- 缓存策略

### 6.2 检索优化
- 向量索引预计算
- 结果缓存
- 懒加载策略

### 6.3 UI优化
- 虚拟滚动
- 代码分割
- 防抖/节流

## 7. 开发计划

### 第一阶段：基础功能（1-2周）
- [x] 项目初始化和基础架构搭建
- [ ] 文件树组件开发
- [ ] Monaco Editor集成
- [ ] 基础文件操作功能

### 第二阶段：类型支持（1周）
- [ ] TypeScript语言服务集成
- [ ] 类型提示功能
- [ ] 错误诊断显示

### 第三阶段：AI索引系统（2-3周）
- [ ] AST解析器实现
- [ ] 代码分块算法
- [ ] 向量生成和存储
- [ ] 索引管理服务

### 第四阶段：AI检索和交互（2周）
- [ ] 检索算法实现
- [ ] Vercel AI SDK集成
- [ ] Prompt工程
- [ ] AI面板开发

### 第五阶段：优化和完善（1周）
- [ ] 性能优化
- [ ] UI美化
- [ ] 测试和调试
- [ ] 文档编写

## 8. 技术挑战和解决方案

### 8.1 挑战
1. **实时索引更新**：如何在用户编辑时高效更新索引
2. **上下文相关性**：如何准确判断代码片段的相关性
3. **性能平衡**：在功能丰富性和性能之间找到平衡
4. **Token限制**：如何在LLM的token限制内提供足够上下文

### 8.2 解决方案
1. **增量更新机制**：只更新变化的部分
2. **多维度评分**：结合语义、结构、使用频率等多个维度
3. **渐进式加载**：优先加载核心功能，其他功能按需加载
4. **智能裁剪**：根据相关性动态调整上下文内容

## 9. 扩展性设计

### 9.1 插件系统
- 支持自定义语言解析器
- 支持自定义AI模型
- 支持自定义UI组件

### 9.2 数据导出
- 支持导出索引数据
- 支持导出使用统计
- 支持导出配置

## 10. 总结

本产品旨在创建一个功能完善的AI辅助代码编辑器Demo，通过深度集成AI能力，为开发者提供智能化的编程体验。重点在于实现代码库级别的上下文理解和智能检索，让AI真正理解项目结构和代码关系，从而提供更准确的代码建议和补全。